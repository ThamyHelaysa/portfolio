<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="description" content="{{ description or metadata.description }}">
    <title>{{ title or "My Portfolio" }}</title>

    
    {# Start our CSP lists with 'self' #}
    {% set cspScriptSrc = "'self'" %}
    {% set cspStyleSrc = "'self'" %}

    {# Initialize buffers to hold the actual HTML tags we want to print later #}
    {% set scriptsOutput = "" %}
    {% set stylesOutput = "" %}

    {% set themeContent %}{% include "inline-theme.js" %}{% endset %}
    {% set themeHash = themeContent | trim | cspHash %}

    {% set cspScriptSrc = cspScriptSrc + " " + themeHash %}
    {% set scriptsOutput = scriptsOutput + '<script>' + (themeContent | safe | trim) + '</script>' %}
    
    {# Handle optional page script #}
    {% if inlineScripts %}
      {% for path in inlineScripts %}
        {# 1. Read file #}
        {% set content %}{% include path %}{% endset %}
        
        {# 2. Hash it #}
        {% set hash = content | trim | cspHash %}
        {% set cspScriptSrc = cspScriptSrc + " " + hash %}
        
        {# 3. Store the tag for later #}
        {% set scriptsOutput = scriptsOutput + '<script>' + (content | safe | trim) + '</script>' %}
      {% endfor %}
    {% endif %}

    {% if inlineStyles %}
      {% for path in inlineStyles %}
        {# 1. Read file #}
        {% set content %}{% include path %}{% endset %}
        
        {# 2. Hash it #}
        {% set hash = content | trim | cspHash %}
        {% set cspStyleSrc = cspStyleSrc + " " + hash %}
        
        {# 3. Store the tag for later #}
        {% set stylesOutput = stylesOutput + '<style>' + (content | safe | trim) + '</style>' %}
      {% endfor %}
    {% endif %}

    {% set fontCss %}{% include "css/fonts.css" %}{% endset %}

    {% set fontHash = fontCss | trim | cspHash %}
    {% set cspStyleSrc = cspStyleSrc + " " + fontHash %}

    {% set stylesOutput = stylesOutput + '<style>' + (fontCss | safe | trim) + '</style>' %}
    {# /////////////// #}
    {% set compsCss %}{% include "css/default.css" %}{% endset %}

    {% set compsHash = compsCss | trim | cspHash %}
    {% set cspStyleSrc = cspStyleSrc + " " + compsHash %}

    {% set stylesOutput = stylesOutput + '<style>' + (compsCss | safe | trim) + '</style>' %}

    <meta 
      http-equiv="Content-Security-Policy" 
      content="default-src 'self'; script-src {{ cspScriptSrc }}; style-src {{ cspStyleSrc }};"
    >
    <meta name="view-transition" content="same-origin">
    
    {{ stylesOutput | safe }}

    <link rel="preload" href="/assets/css/menu-mobile-shadow.css" as="fetch" crossorigin>
    <link rel="preload" href="/assets/css/toggle-theme-shadow.css" as="fetch" crossorigin>

    <link rel="preload" href="/assets/fonts/pf-display-v40-latin/playfair-display-v40-latin-900.woff2" as="font" type="font/woff2" crossorigin/>
    <link rel="preload" href="/assets/fonts/pf-display-v40-latin/playfair-display-v40-latin-900italic.woff2" as="font" type="font/woff2" crossorigin/>
    <link rel="preload" href="/assets/fonts/lato-v25-latin/lato-v25-latin-300.woff2" as="font" type="font/woff2" crossorigin/>

    <link rel="stylesheet" href="/assets/css/global.css">

    <script type="module" src="/components/theme-toggle.js"></script>
    <script type="module" src="/components/menu-mobile.js"></script>

    {% if pageModules %}
      {% for url in pageModules %}
        <script type="module" src="{{ url }}"></script>
      {% endfor %}
    {% endif %}

    {{ scriptsOutput | safe }}
  </head>
  <body class="font-serif dotted-bg">
    <div class="min-h-screen text-text-dark selection:bg-accent-red selection:text-white flex flex-col">
      
      {% include "partials/header.njk" %}

      <main class="will-change-[opacity] transition grow flex flex-col w-full max-w-6xl min-h-dvh mx-auto px-6 md:px-12 py-12">
        {{ content | safe }}
      </main>

      {% include "partials/footer.njk" %}
    </div>
  </body>
</html>
